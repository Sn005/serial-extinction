# ライティングオーケストレーター（統括エージェント）

**発動条件**: 「執筆フロー開始」「章を完成させて」「オーケストレーション」等のキーワード

---

## 目的

章の執筆から完成までの全プロセスを統括し、各サブエージェントを適切な順序で呼び出す。
品質ゲートを管理し、必要に応じて反復的な改善を実施する。

---

## 執筆ワークフロー全体図

```
┌─────────────────────────────────────────────────────────────────┐
│                    執筆オーケストレーション                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Phase 1: 準備                                                  │
│  ┌─────────────────┐                                            │
│  │ /story-analyzer │ → 物語の流れ・構成を分析                     │
│  └────────┬────────┘                                            │
│           ▼                                                     │
│  ┌─────────────────────┐                                        │
│  │ /chapter-outliner   │ → 章の詳細アウトラインを作成             │
│  └────────┬────────────┘                                        │
│           ▼                                                     │
│  ┌─────────────────────┐                                        │
│  │ ユーザー承認        │ ← アウトライン確認                       │
│  └────────┬────────────┘                                        │
│                                                                 │
│  Phase 2: 執筆                                                  │
│           ▼                                                     │
│  ┌─────────────────────┐                                        │
│  │ /chapter-writer     │ → 章を執筆                             │
│  └────────┬────────────┘                                        │
│                                                                 │
│  Phase 3: 品質保証                                              │
│           ▼                                                     │
│  ┌─────────────────────┐                                        │
│  │ /proofreader        │ → 校正（誤字・表記ゆれ）                 │
│  └────────┬────────────┘                                        │
│           ▼                                                     │
│  ┌─────────────────────┐                                        │
│  │ /quality-reviewer   │ → 品質レビュー                          │
│  └────────┬────────────┘                                        │
│           │                                                     │
│           ▼                                                     │
│      スコア確認                                                  │
│       ├── A/B (40+) → Phase 4へ                                 │
│       └── C/D/E (<40) → 修正ループへ                             │
│                                                                 │
│  修正ループ:                                                     │
│  ┌─────────────────────┐                                        │
│  │ /reviser            │ → レビューに基づく修正                   │
│  └────────┬────────────┘                                        │
│           │                                                     │
│           └──────► /quality-reviewer に戻る（最大3回）           │
│                                                                 │
│  Phase 4: 最終確認                                              │
│           ▼                                                     │
│  ┌─────────────────────┐                                        │
│  │ /final-checker      │ → 全体整合性の最終確認                   │
│  └────────┬────────────┘                                        │
│           │                                                     │
│           ▼                                                     │
│      最終判定                                                    │
│       ├── ✅承認 → 完了                                          │
│       └── ⚠️/❌ → /reviser で追加修正                            │
│                                                                 │
│  Phase 5: 完了処理                                              │
│           ▼                                                     │
│  ┌─────────────────────┐                                        │
│  │ ドキュメント更新     │                                        │
│  │ - シナリオ構成表     │                                        │
│  │ - 伏線管理表         │                                        │
│  │ - 用語辞典           │                                        │
│  └─────────────────────┘                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 実行内容

### Phase 1: 準備

#### 1.1 物語分析
```
/story-analyzer を実行
```
- 既存章の状態確認
- 次章への接続ポイント
- 回収すべき伏線の特定

#### 1.2 アウトライン作成
```
/chapter-outliner Extinction XX を実行
```
- 詳細アウトラインの作成
- ACの具体化
- セクション構造の設計

#### 1.3 ユーザー承認
- アウトラインをユーザーに提示
- 修正要望の反映
- 承認後、Phase 2へ

### Phase 2: 執筆

```
/chapter-writer Extinction XX を実行
```
- アウトラインに基づく執筆
- 文体ガイドラインの遵守
- 伏線の埋め込み

### Phase 3: 品質保証

#### 3.1 校正
```
/proofreader Extinction XX を実行
```
- 誤字・脱字の修正
- 表記ゆれの統一

#### 3.2 品質レビュー
```
/quality-reviewer Extinction XX を実行
```
- 総合的な品質評価
- 改善提案の生成

#### 3.3 品質ゲート判定

| スコア | 判定 | アクション |
|--------|------|------------|
| 50-60 (A) | ✅通過 | Phase 4へ |
| 40-49 (B) | ✅通過 | Phase 4へ（軽微修正推奨） |
| 30-39 (C) | ⚠️条件付き | 修正ループへ |
| 20-29 (D) | ❌不通過 | 修正ループへ |
| 0-19 (E) | ❌不通過 | 大幅修正または再執筆 |

#### 3.4 修正ループ（必要な場合）
```
/reviser Extinction XX を実行
↓
/quality-reviewer Extinction XX を再実行
```
- 最大3回の反復
- 3回で品質ゲートを通過しない場合、ユーザーに相談

### Phase 4: 最終確認

```
/final-checker を実行
```
- 全体整合性の確認
- 伏線管理の確認
- テーマ一貫性の確認

### Phase 5: 完了処理

#### 5.1 ドキュメント更新
- **@docs/04_plot-structure.md**: 状態を ✅完了 に更新
- **@docs/04_plot-structure.md**: 伏線管理表を更新
- **@docs/07_terminology.md**: 新出用語を追加

#### 5.2 完了報告
- 章の完成を報告
- 次章執筆への推奨事項

---

## 品質基準

### 品質ゲート: レビュー通過

| 項目 | 必須基準 |
|------|---------|
| 整合性 | 6/10以上 |
| 文体 | 6/10以上 |
| ダイナミズム | 5/10以上 |
| 伏線管理 | 7/10以上 |
| 描写の厚み | 5/10以上 |
| AC達成度 | 7/10以上 |
| 総合スコア | 40/60以上 |

### 品質ゲート: 最終承認

| 項目 | 必須基準 |
|------|---------|
| 縦断的整合性 | ✅ |
| テーマ一貫性 | ✅ |
| 物質的連続性 | ✅ |
| 伏線管理 | 未回収超過なし |

---

## 出力形式

```markdown
## オーケストレーションレポート: Extinction XX

### 実行サマリー

| Phase | ステップ | 状態 | 備考 |
|-------|----------|------|------|
| 1 | story-analyzer | ✅完了 | - |
| 1 | chapter-outliner | ✅完了 | ユーザー承認済み |
| 2 | chapter-writer | ✅完了 | 24,500字 |
| 3 | proofreader | ✅完了 | 5件修正 |
| 3 | quality-reviewer #1 | ✅完了 | スコア: 35/60 (C) |
| 3 | reviser #1 | ✅完了 | 8件修正 |
| 3 | quality-reviewer #2 | ✅完了 | スコア: 48/60 (B) |
| 4 | final-checker | ✅完了 | 承認 |
| 5 | ドキュメント更新 | ✅完了 | - |

---

### 品質推移

```
初回レビュー: 35/60 (C)
    ↓ [修正ループ #1]
再レビュー:   48/60 (B) ✅品質ゲート通過
```

---

### 最終成果物

| 項目 | 結果 |
|------|------|
| 章タイトル | Extinction XX: [通名] |
| 文字数 | XX,XXX字 |
| 品質スコア | XX/60 (X) |
| 最終判定 | ✅承認 |

---

### 更新したドキュメント

1. **@docs/04_plot-structure.md**
   - 状態: ⬜未着手 → ✅完了
   - 文字数: 実績追加
   - 伏線: 2件追加、1件回収

2. **@docs/07_terminology.md**
   - 新出用語: 3件追加

---

### 次章への引き継ぎ

#### 接続ポイント
- [次章への接続内容]

#### 回収すべき伏線
1. [伏線A] - 回収予定: 第Y章
2. [伏線B] - 回収予定: 第Z章

---

### 推奨事項

1. [次章執筆時の推奨事項1]
2. [次章執筆時の推奨事項2]
```

---

## 使用例

### 標準フロー
```
/writing-orchestrator Extinction 04
```

### 途中から再開
```
/writing-orchestrator Extinction 04 --from=quality-reviewer
```

### 複数章の連続執筆
```
Extinction 04から06まで順番に執筆してください
```

---

## エラーハンドリング

### 品質ゲート不通過（3回反復後）
1. ユーザーに状況を報告
2. 問題箇所の詳細を提示
3. 以下の選択肢を提案:
   - 追加修正の続行
   - 部分的な再執筆
   - アウトラインからやり直し

### 整合性エラー（最終確認時）
1. エラー箇所の特定
2. 影響範囲の分析
3. 修正方針の提案
4. ユーザー承認後、修正実行

---

## 既存スキルとの関係

### 統合されるスキル
| スキル | 統合先 |
|--------|--------|
| /consistency-checker | /quality-reviewer に統合 |
| /style-reviewer | /quality-reviewer に統合 |
| /foreshadowing-tracker | /quality-reviewer, /final-checker に統合 |
| /chapter-summary | /final-checker に統合 |

### 単独使用も可能
上記のスキルは引き続き単独で使用可能。
オーケストレーターは全体フローを管理する際に使用。

---

## 設定オプション

### 品質基準のカスタマイズ

```yaml
quality_gate:
  review_pass_score: 40  # レビュー通過スコア（デフォルト: 40）
  max_revision_loops: 3  # 最大修正ループ回数（デフォルト: 3）
  auto_approve_score: 50 # 自動承認スコア（デフォルト: 50）
```

### 実行モード

| モード | 説明 |
|--------|------|
| full | 全フェーズを実行（デフォルト） |
| draft | 執筆のみ、レビューなし |
| review | レビュー・修正のみ |
| check | 最終確認のみ |
